{% extends layout_path %}
{% load static %}
{% load i18n %}

{% block title %}Dashboard - Analytics{% endblock title %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const selectYear = document.getElementById("selectYear");
    let multilineChartInstance = null;
    let multibarChartInstance = null;

    function loadYears() {
      fetch("/DataByYear/")
        .then(response => response.json())
        .then(data => {
          data.forEach(year => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            selectYear.appendChild(option);
          });

          const selectedYear = new Date().getFullYear();
          selectYear.value = selectedYear;
          updateCharts(selectedYear);
        });
    }
  function updateCharts(year) {
    fetch(`/multilineChart/?year=${year}`)
      .then(response => response.json())
      .then(data => {
        const monthOrder = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
        const monthLabels = {
          "01": "Jan", "02": "Feb", "03": "Mar", "04": "Apr", "05": "May", "06": "Jun",
          "07": "Jul", "08": "Aug", "09": "Sep", "10": "Oct", "11": "Nov", "12": "Dec"
        };

        const labels = monthOrder.map(m => monthLabels[m]);

        const colors = ["#1fd43f", "#59405d", "#e26a2c", "#007bff", "#ff00aa"];
        const datasets = [];

        Object.entries(data).forEach(([country, values], index) => {
          const counts = monthOrder.map(month => values[month] || 0);

          datasets.push({
            label: country,
            data: counts,
            borderColor: colors[index % colors.length],
            pointBorderColor: "#FFF",
            pointBackgroundColor: colors[index % colors.length],
            fill: true,
            backgroundColor: "transparent",
            borderWidth: 2
          });
        });

        if (multilineChartInstance) {
            multilineChartInstance.destroy();
        }

        const ctx = document.getElementById("multipleLineChart").getContext("2d");
        multilineChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              title: {
                display: true,
                text: "Top 3 Countries with Fire Incidents this Year"
              },
              tooltip: {
                mode: "index",
                intersect: false
              }
            },
            scales: {
              x: {
                stacked: false
              },
              y: {
                stacked: false
              }
            }
          }
        });
      })
      .catch(error => console.error("Chart load error:", error));
      
    fetch(`/multiBarChart/?year=${year}`)
      .then((response) => response.json())
      .then((result) => {
          var dataForYear = result[year] || {};
          var severitylevel = Object.keys(dataForYear);
          // Extract incident counts for each severity level
          var incidentCount_major = [];
          var incidentCount_minor = [];
          var incidentCount_moderate = [];

          var months = Object.keys(result);
          var counts = Object.values(result);

          // Sort function to sort object keys by month
          function sortObjectKeys(obj) {
          return Object.keys(obj).sort((a, b) => parseInt(a) - parseInt(b));
          }

          // Check if data for each severity level exists and extract incident counts
          if (severitylevel.length >= 1) {
            const sl1_data = dataForYear[severitylevel[0]];
            const sortedKeys1 = sortObjectKeys(sl1_data);
            incidentCount_major = sortedKeys1.map(key => sl1_data[key]);
          }

          if (severitylevel.length >= 2) {
            const sl2_data = dataForYear[severitylevel[1]];
            const sortedKeys2 = sortObjectKeys(sl2_data);
            incidentCount_minor = sortedKeys2.map(key => sl2_data[key]);
          }

          if (severitylevel.length >= 3) {
            const sl3_data = dataForYear[severitylevel[2]];
            const sortedKeys3 = sortObjectKeys(sl3_data);
            incidentCount_moderate = sortedKeys3.map(key => sl3_data[key]);
          }

          if (multibarChartInstance) {
            multibarChartInstance.destroy();
          }

          const ctxBar = document.getElementById("multipleBarChart").getContext("2d");
          multibarChartInstance = new Chart(ctxBar, {
          type: "bar",
          data: {
              labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
              datasets: [
              {
                  label: "Minor Fire",
                  backgroundColor: "#595d5d",
                  borderColor: "#595d5d",
                  data: incidentCount_minor,
              },
              {
                  label: "Moderate Fire",
                  backgroundColor: "#f4a84b",
                  borderColor: "#f4a84b",
                  data: incidentCount_moderate,
              },
              {
                  label: "Major Fire",
                  backgroundColor: "#1174d7",
                  borderColor: "#1174d7",
                  data: incidentCount_major,
              },
              ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              position: "bottom"
            },
            title: {
              display: true,
              text: "Fire Incidents by Severity Level"
            },
            tooltips: {
              mode: "index",
              intersect: false
            },
            scales: {
              x: {
                stacked: true,
              },
              y: {
                stacked: true,
              },
            },
          },
          });
      })
      .catch((error) => console.error("Error:", error));
  }

  selectYear.addEventListener("change", () => {
    const selectedYear = selectYear.value;
    updateCharts(selectedYear);
  });

  loadYears();
</script>
{% endblock vendor_js %}

{% block content %}
<div class="container-fluid">
  <div class="row gy-4 mb-4">
    <div class="col-md-12 col-lg-4">
      <div class="card">
        <div class="card-body text-nowrap">
          <h5 class="card-title mb-0 flex-wrap text-nowrap">Congratulations Norris! ðŸŽ‰</h5>
          <p class="mb-2">Best seller of the month</p>
          <h4 class="text-primary mb-0">$42.8k</h4>
          <p class="mb-2">78% of target ðŸš€</p>
          <a href="javascript:;" class="btn btn-sm btn-primary">View Sales</a>
        </div>
        <img src="{% static 'img/illustrations/trophy.png' %}" class="position-absolute bottom-0 end-0 me-5 mb-5" width="83" alt="view sales">
      </div>
    </div>
  </div>
  <div class="row gy-6">

    <!-- Weekly Overview Chart -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Fire Incidents Top 3 Countries</div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="multipleLineChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
              <div class="card">
                  <div class="card-header">
                      <div class="card-title">Total Incidents for each Month</div>
                  </div>
                  <div class="card-body">
                      <div class="chart-container">
                          <canvas id="multipleBarChart"></canvas>
                      </div>
                  </div>
              </div>
        </div>
    </div>
  <div class="d-flex justify-content-end mb-4 mt-2">
    <div class="d-flex align-items-center gap-2" style="min-width: 160px;">
      <label for="selectYear" class="form-label mb-0">Year:</label>
      <select id="selectYear" class="form-select form-select-sm"></select>
    </div>
  </div>
</div>
{% endblock content %}