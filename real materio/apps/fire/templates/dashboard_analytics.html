{% extends layout_path %}
{% load static %}
{% load i18n %}

{% block title %}Dashboard - Analytics{% endblock title %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    fetch("/multilineChart/")
      .then(response => response.json())
      .then(data => {
        const monthOrder = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
        const monthLabels = {
          "01": "Jan", "02": "Feb", "03": "Mar", "04": "Apr", "05": "May", "06": "Jun",
          "07": "Jul", "08": "Aug", "09": "Sep", "10": "Oct", "11": "Nov", "12": "Dec"
        };

        const labels = monthOrder.map(m => monthLabels[m]);

        const colors = ["#1fd43f", "#59405d", "#e26a2c", "#007bff", "#ff00aa"];
        const datasets = [];

        Object.entries(data).forEach(([country, values], index) => {
          const counts = monthOrder.map(month => values[month] || 0);

          datasets.push({
            label: country,
            data: counts,
            borderColor: colors[index % colors.length],
            pointBorderColor: "#FFF",
            pointBackgroundColor: colors[index % colors.length],
            fill: true,
            backgroundColor: "transparent",
            borderWidth: 2
          });
        });

        const ctx = document.getElementById("multipleLineChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              title: {
                display: true,
                text: "Top 3 Countries with Fire Incidents this Year"
              },
              tooltip: {
                mode: "index",
                intersect: false
              }
            },
            scales: {
              x: {
                stacked: false
              },
              y: {
                stacked: false
              }
            }
          }
        });
      })
      .catch(error => console.error("Chart load error:", error));
      
    fetch("/multiBarChart/")
      .then((response) => response.json())
      .then((result) => {
          var severitylevel = Object.keys(result);
          // Extract incident counts for each severity level
          var incidentCount_major = [];
          var incidentCount_minor = [];
          var incidentCount_moderate = [];

          var months = Object.keys(result);
          var counts = Object.values(result);

          // Sort function to sort object keys by month
          function sortObjectKeys(obj) {
          return Object.keys(obj).sort((a, b) => parseInt(a) - parseInt(b));
          }

          // Check if data for each severity level exists and extract incident counts
          if (severitylevel.length >= 1) {
          var sl1_data = result[severitylevel[0]];
          var sortedKeys1 = sortObjectKeys(sl1_data);
          incidentCount_major = sortedKeys1.map((key) => sl1_data[key]);
          }

          if (severitylevel.length >= 2) {
          var sl2_data = result[severitylevel[1]];
          var sortedKeys2 = sortObjectKeys(sl2_data);
          incidentCount_minor = sortedKeys2.map((key) => sl2_data[key]);
          }

          if (severitylevel.length >= 3) {
          var sl3_data = result[severitylevel[2]];
          var sortedKeys3 = sortObjectKeys(sl3_data);
          incidentCount_moderate = sortedKeys3.map((key) => sl3_data[key]);
          }

          // Now create the chart after the data is ready
          var multipleBarChart = document.getElementById("multipleBarChart").getContext("2d");

          new Chart(multipleBarChart, {
          type: "bar",
          data: {
              labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
              datasets: [
              {
                  label: "Minor Fire",
                  backgroundColor: "#595d5d",
                  borderColor: "#595d5d",
                  data: incidentCount_minor,
              },
              {
                  label: "Moderate Fire",
                  backgroundColor: "#f4a84b",
                  borderColor: "#f4a84b",
                  data: incidentCount_moderate,
              },
              {
                  label: "Major Fire",
                  backgroundColor: "#1174d7",
                  borderColor: "#1174d7",
                  data: incidentCount_major,
              },
              ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              position: "bottom"
            },
            title: {
              display: true,
              text: "Fire Incidents by Severity Level"
            },
            tooltips: {
              mode: "index",
              intersect: false
            },
            scales: {
              x: {
                stacked: true,
              },
              y: {
                stacked: true,
              },
            },
          },
          });
      })
      .catch((error) => console.error("Error:", error));
          
  </script>
{% endblock vendor_js %}

{% block content %}
<div class="row gy-6">

  <!-- Weekly Overview Chart -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Fire Incidents Top 3 Countries</div>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="multipleLineChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Total Incidents for each Month</div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="multipleBarChart"></canvas>
                    </div>
                </div>
            </div>
    </div>
</div>

{% endblock content %}